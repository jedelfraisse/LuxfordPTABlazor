@page "/admin/events/create"
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@using LuxfordPTAWeb.Shared.Models
@using LuxfordPTAWeb.Shared.DTOs
@using LuxfordPTAWeb.Shared.Enums

<PageTitle>New Event</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-calendar-week"></i> Create Event
    </h1>
    <div>
        <a href="/admin/events" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left"></i> Back to Events
        </a>
    </div>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
    </div>
}

@if (isLoading)
{
    <div class="alert alert-info">
        <em>Loading...</em>
    </div>
}
else if (createEventDto != null)
{
    <div class="row">
        <div class="col-lg-8">
            <!-- Basic Event Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Basic Event Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="title" class="form-label">Event Title *</label>
                            <input type="text" class="form-control" id="title" @bind="createEventDto.Title" required />
                        </div>
                        <div class="col-md-4">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" @bind="createEventDto.Status">
                                <option value="@EventStatus.Planning">Planning</option>
                                <option value="@EventStatus.SubmittedForApproval">Submit for Approval</option>
                                <option value="@EventStatus.Active">Active</option>
                                <option value="@EventStatus.InProgress">In Progress</option>
                                <option value="@EventStatus.Completed">Completed</option>
                                <option value="@EventStatus.Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" rows="4" @bind="createEventDto.Description"></textarea>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="schoolYear" class="form-label">School Year *</label>
                            <select class="form-select" id="schoolYear" @bind="createEventDto.SchoolYearId" required>
                                <option value="0">Select School Year</option>
                                @if (schoolYears != null)
                                {
                                    @foreach (var year in schoolYears)
                                    {
                                        <option value="@year.Id">@year.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="eventCategory" class="form-label">Event Category *</label>
                            <select class="form-select" id="eventCategory" @bind="createEventDto.EventCatId" @bind:after="OnCategoryChanged" required>
                                <option value="0">Select Category</option>
                                @if (eventCategories != null)
                                {
                                    @foreach (var category in eventCategories)
                                    {
                                        <option value="@category.Id">@category.Name</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="eventSubCategory" class="form-label">Event Sub-Category</label>
                            <select class="form-select" id="eventSubCategory" @bind="eventSubCategoryId">
                                <option value="0">Select Sub-Category</option>
                                @if (eventSubcategories != null)
                                {
                                    @foreach (var subcat in eventSubcategories.Where(sc => sc.EventCatId == createEventDto.EventCatId && sc.IsActive).OrderBy(sc => sc.DisplayOrder))
                                    {
                                        <option value="@subcat.Id">@subcat.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" @bind="createEventDto.Location" />
                        </div>
                    </div>

                    <!-- Event Coordinator Section - conditional based on category settings -->
                    @if (ShouldShowCoordinatorField())
                    {
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="eventCoordinator" class="form-label">
                                    Event Coordinator
                                    @if (IsCoordinatorRequired())
                                    {
                                        <span class="text-danger">*</span>
                                        <i class="bi bi-info-circle ms-1" title="A coordinator is required for events in this category"></i>
                                    }
                                    else
                                    {
                                        <i class="bi bi-info-circle ms-1" title="Event coordinator is optional for this category"></i>
                                    }
                                </label>
                                <select class="form-select" id="eventCoordinator" @bind="createEventDto.EventCoordinatorId">
                                    <option value="">@(IsCoordinatorRequired() ? "Select Coordinator" : "No Coordinator Assigned")</option>
                                    @if (availableCoordinators != null)
                                    {
                                        @foreach (var coordinator in availableCoordinators)
                                        {
                                            <option value="@coordinator.Id">@coordinator.FirstName @coordinator.LastName (@coordinator.Email)</option>
                                        }
                                    }
                                </select>
                                @if (IsCoordinatorRequired())
                                {
                                    <div class="form-text text-muted">
                                        Events in this category require a designated coordinator to manage logistics and communications.
                                    </div>
                                }
                                else
                                {
                                    <div class="form-text text-muted">
                                        Optionally assign a coordinator to manage event logistics and communications.
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            Events in this category do not require a coordinator assignment.
                        </div>
                    }
                    
                    <!-- Day 1 Information (Primary Event Day) -->
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white py-2">
                            <h6 class="mb-0"><i class="bi bi-calendar-date"></i> Primary Event Day</h6>
                        </div>
                        <div class="card-body py-3">
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label for="eventDate" class="form-label">Event Date *</label>
                                    <input type="date" class="form-control" id="eventDate" @bind="primaryDay.Date" @bind:format="yyyy-MM-dd" required />
                                </div>
                                <div class="col-md-6">
                                    <label for="dayTitle" class="form-label">Day Title (optional)</label>
                                    <input type="text" class="form-control" id="dayTitle" @bind="primaryDay.DayTitle" placeholder="e.g., 'Opening Day', 'Main Event'" />
                                </div>
                            </div>
                            
                            <!-- Time Range Section -->
                            <div class="mb-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="allDayPrimary" checked="@primaryDayIsAllDay" @onchange="@(e => OnPrimaryDayAllDayChanged((bool?)e.Value ?? false))" />
                                    <label class="form-check-label" for="allDayPrimary">All Day Event</label>
                                </div>
                            </div>
                            
                            @if (!primaryDayIsAllDay)
                            {
                                <div class="row mb-2">
                                    <div class="col-6">
                                        <label for="startTime" class="form-label">Start Time</label>
                                        <input type="time" class="form-control" id="startTime" value="@primaryDayStartTime" @onchange="@(e => UpdatePrimaryStartTimeFromInput(e.Value?.ToString()))" />
                                    </div>
                                    <div class="col-6">
                                        <label for="endTime" class="form-label">End Time</label>
                                        <input type="time" class="form-control" id="endTime" value="@primaryDayEndTime" @onchange="@(e => UpdatePrimaryEndTimeFromInput(e.Value?.ToString()))" />
                                    </div>
                                </div>
                            }
                            
                            <div class="mb-2">
                                <label for="dayDescription" class="form-label">Day-Specific Description (optional)</label>
                                <textarea class="form-control" id="dayDescription" rows="2" @bind="primaryDay.Description" placeholder="Specific activities or details for this day"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="requiresVolunteers" @bind="createEventDto.RequiresVolunteers">
                        <label class="form-check-label" for="requiresVolunteers">
                            Requires Volunteers
                        </label>
                    </div>
                    @if (createEventDto.RequiresVolunteers)
                    {
                        <div class="card mb-4 border-warning">
                            <div class="card-header">
                                <strong><i class="bi bi-people"></i> Volunteer Details</strong>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Number of Volunteer Spots</label>
                                    <input type="number" class="form-control" @bind="volunteerSpots" min="1" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">SignUpGenius Link</label>
                                    <input type="url" class="form-control" @bind="signUpGeniusLink" placeholder="https://www.signupgenius.com/go/..." />
                                </div>
                                @if (!string.IsNullOrWhiteSpace(signUpGeniusLink))
                                {
                                    <div class="alert alert-info">
                                        <a href="@signUpGeniusLink" target="_blank">View Volunteer Signup</a>
                                    </div>
                                }
                                <!-- Future: Integrate SignUpGenius API or scraping for slots -->
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Additional Event Days (only show if there are additional days) -->
            @if (additionalDays.Any())
            {
                <div class="card mb-4 border-info">
                    <div class="card-header d-flex justify-content-between align-items-center bg-light">
                        <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Additional Event Days <span class="badge bg-info ms-2">Multi-Day Event</span></h5>
                        <button type="button" class="btn btn-outline-primary btn-sm" @onclick="AddAdditionalDay">
                            <i class="bi bi-plus"></i> Add Another Day
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @foreach (var day in additionalDays.OrderBy(d => d.DayNumber))
                            {
                                <div class="col-md-6 mb-3">
                                    <div class="card border-info">
                                        <div class="card-header d-flex justify-content-between align-items-center py-2">
                                            <small class="text-muted">Day @day.DayNumber</small>
                                            <button type="button" class="btn btn-outline-danger btn-sm" @onclick="() => RemoveAdditionalDay(day)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="mb-2">
                                                <label class="form-label small">Day Title</label>
                                                <input type="text" class="form-control form-control-sm" @bind="day.DayTitle" placeholder="e.g., 'Fire Safety Demo'" />
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small">Date *</label>
                                                <input type="date" class="form-control form-control-sm" @bind="day.Date" @bind:format="yyyy-MM-dd" required />
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label small">Location (optional)</label>
                                                <input type="text" class="form-control form-control-sm" @bind="day.Location" placeholder="Override default location" />
                                            </div>
                                            
                                            <!-- Time Range Section -->
                                            <div class="mb-2">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" checked="@GetIsAllDay(day)" @onchange="@(e => OnAllDayChanged(day, (bool?)e.Value ?? false))" />
                                                    <label class="form-check-label small">All Day Event</label>
                                                </div>
                                            </div>
                                            
                                            @if (!GetIsAllDay(day))
                                            {
                                                <div class="row mb-2">
                                                    <div class="col-6">
                                                        <label for="startTime" class="form-label small">Start Time</label>
                                                        <input type="time" class="form-control form-control-sm" value="@GetStartTimeString(day)" @onchange="@(e => UpdateStartTimeFromInput(day, e.Value?.ToString()))" />
                                                    </div>
                                                    <div class="col-6">
                                                        <label for="endTime" class="form-label small">End Time</label>
                                                        <input type="time" class="form-control form-control-sm" value="@GetEndTimeString(day)" @onchange="@(e => UpdateEndTimeFromInput(day, e.Value?.ToString()))" />
                                                    </div>
                                                </div>
                                            }
                                            
                                            <div class="mb-2">
                                                <label class="form-label small">Description</label>
                                                <textarea class="form-control form-control-sm" rows="2" @bind="day.Description" placeholder="Day-specific activities"></textarea>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" @bind="day.IsActive" />
                                                <label class="form-check-label small">Active</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- Multi-Day Option -->
                <div class="card mb-4 border-info">
                    <div class="card-body text-center py-4">
                        <h6 class="text-muted mb-3"><i class="bi bi-calendar-plus"></i> Is this a multi-day event?</h6>
                        <button type="button" class="btn btn-outline-info" @onclick="AddAdditionalDay">
                            <i class="bi bi-plus-circle"></i> Add Additional Days
                        </button>
                        <p class="text-muted small mt-2">Perfect for events like Fire Prevention Week, Book Fair, Spirit Week, etc.</p>
                    </div>
                </div>
            }
        </div>

        <!-- Action Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary" @onclick="SaveEvent" disabled="@isSaving">
                            @if (isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="bi bi-save"></i> Create Event
                        </button>
                        <button type="button" class="btn btn-outline-secondary" @onclick="CancelEdit">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                    </div>
                    <!-- Event Summary -->
                    <hr />
                    <h6>Event Summary</h6>
                    <ul class="list-unstyled small">
                        <li><strong>Total Days:</strong> @(1 + additionalDays.Count)</li>
                        <li><strong>Date Range:</strong> 
                            @{
                                var allEventDays = new List<EventDay> { primaryDay };
                                allEventDays.AddRange(additionalDays);
                                
                                if (allEventDays.Count > 1 && allEventDays.Any())
                                {
                                    var startDate = allEventDays.Min(d => d.Date);
                                    var endDate = allEventDays.Max(d => d.Date);
                                    <span>@startDate.ToString("MMM d") - @endDate.ToString("MMM d, yyyy")</span>
                                }
                                else if (primaryDay.Date != DateTime.MinValue)
                                {
                                    <span>@primaryDay.Date.ToString("MMM d, yyyy")</span>
                                }
                                else
                                {
                                    <span class="text-muted">Not set</span>
                                }
                            }
                        </li>
                        <li><strong>Status:</strong> <span class="badge bg-secondary">@createEventDto.Status</span></li>
                        @if (primaryDayIsAllDay && additionalDays.All(d => GetIsAllDay(d)))
                        {
                            <li><strong>Time:</strong> <span class="text-muted">All Day</span></li>
                        }
                        else if (!primaryDayIsAllDay)
                        {
                            <li><strong>Primary Day Time:</strong> @primaryDayStartTime - @primaryDayEndTime</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private int volunteerSpots = 0;
    private string signUpGeniusLink = string.Empty;
    private CreateEventDTO? createEventDto;
    private EventDay primaryDay = new();
    private List<EventDay> additionalDays = new();
    private List<SchoolYear>? schoolYears;
    private List<EventCat>? eventCategories;
    private List<EventCatSub>? eventSubcategories;
    private List<ApplicationUser>? availableCoordinators;
    private bool isLoading = true;
    private bool isSaving = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private int eventSubCategoryId = 0;
    
    // Primary day time tracking
    private bool primaryDayIsAllDay = true;
    private string primaryDayStartTime = "09:00";
    private string primaryDayEndTime = "15:00";
    
    // Additional days time tracking
    private Dictionary<int, string> dayStartTimes = new();
    private Dictionary<int, string> dayEndTimes = new();
    private Dictionary<int, bool> dayIsAllDay = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDropdownData();

        // Read query parameters for schoolYearId, eventCatId, and eventSubCatId
        var uri = new Uri(NavigationManager.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        int schoolYearId = 0;
        int eventCatId = 0;
        int eventSubCatId = 0;
        if (query.TryGetValue("schoolYearId", out var syVal))
            int.TryParse(syVal, out schoolYearId);
        if (query.TryGetValue("eventCatId", out var catVal))
            int.TryParse(catVal, out eventCatId);
        if (query.TryGetValue("eventSubCatId", out var subCatVal))
            int.TryParse(subCatVal, out eventSubCatId);

        InitializeNewEvent(schoolYearId, eventCatId, eventSubCatId);
        isLoading = false;
    }
    
    private async Task LoadDropdownData()
    {
        try
        {
            schoolYears = await Http.GetFromJsonAsync<List<SchoolYear>>("api/schoolyears");
            eventCategories = await Http.GetFromJsonAsync<List<EventCat>>("api/eventcat");
            eventSubcategories = await Http.GetFromJsonAsync<List<EventCatSub>>("api/eventcatsub");
            availableCoordinators = await Http.GetFromJsonAsync<List<ApplicationUser>>("api/users/coordinators");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading data: {ex.Message}";
        }
    }
    
    private void InitializeNewEvent(int schoolYearId = 0, int eventCatId = 0, int eventSubCatId = 0)
    {
        createEventDto = new CreateEventDTO
        {
            Title = "",
            Description = "",
            Location = "",
            Status = EventStatus.Planning,
            Date = DateTime.Today.AddDays(7), // Default to next week
            EventStartTime = DateTime.Today.AddDays(7).AddHours(9), // 9 AM
            EventEndTime = DateTime.Today.AddDays(7).AddHours(15), // 3 PM
            RequiresVolunteers = false,
            RequiresSetup = false,
            RequiresCleanup = false,
            SchoolYearId = schoolYearId > 0 ? schoolYearId : 0,
            EventCatId = eventCatId > 0 ? eventCatId : 0
        };
        
        // Set the eventSubCategoryId from query parameter
        eventSubCategoryId = eventSubCatId > 0 ? eventSubCatId : 0;
        
        // Initialize primary day
        primaryDay = new EventDay
        {
            DayNumber = 1,
            Date = DateTime.Today.AddDays(7),
            DayTitle = "",
            Description = "",
            Location = "",
            IsActive = true,
            EventId = 0
        };
        
        // Reset additional days and tracking
        additionalDays.Clear();
        dayStartTimes.Clear();
        dayEndTimes.Clear();
        dayIsAllDay.Clear();
        
        // Initialize primary day time tracking
        primaryDayIsAllDay = true;
        primaryDayStartTime = "09:00";
        primaryDayEndTime = "15:00";
    }

    private void AddAdditionalDay()
    {
        var nextDayNumber = additionalDays.Any() ? additionalDays.Max(d => d.DayNumber) + 1 : 2; // Start from 2 since primary is 1
        var lastDate = additionalDays.Any() ? additionalDays.Max(d => d.Date) : primaryDay.Date;
        var newDay = new EventDay
        {
            DayNumber = nextDayNumber,
            Date = lastDate.AddDays(1),
            DayTitle = $"Day {nextDayNumber}",
            Description = "",
            Location = "",
            IsActive = true,
            EventId = 0
        };
        
        additionalDays.Add(newDay);
        
        // Initialize as all-day by default
        dayIsAllDay[newDay.DayNumber] = true;
        dayStartTimes[newDay.DayNumber] = "09:00";
        dayEndTimes[newDay.DayNumber] = "15:00";
    }

    private void RemoveAdditionalDay(EventDay day)
    {
        additionalDays.Remove(day);
        dayIsAllDay.Remove(day.DayNumber);
        dayStartTimes.Remove(day.DayNumber);
        dayEndTimes.Remove(day.DayNumber);
        
        // Renumber remaining additional days (keeping primary as day 1)
        var orderedDays = additionalDays.OrderBy(d => d.Date).ToList();
        additionalDays.Clear();
        dayIsAllDay.Clear();
        dayStartTimes.Clear();
        dayEndTimes.Clear();
        
        for (int i = 0; i < orderedDays.Count; i++)
        {
            orderedDays[i].DayNumber = i + 2; // Start from 2 since primary is 1
            additionalDays.Add(orderedDays[i]);
            
            // Re-initialize time tracking
            dayIsAllDay[orderedDays[i].DayNumber] = orderedDays[i].StartTime == null;
            dayStartTimes[orderedDays[i].DayNumber] = orderedDays[i].StartTime?.ToString("HH:mm") ?? "09:00";
            dayEndTimes[orderedDays[i].DayNumber] = orderedDays[i].EndTime?.ToString("HH:mm") ?? "15:00";
        }
    }
    
    // Primary day time management
    private void OnPrimaryDayAllDayChanged(bool isAllDay)
    {
        primaryDayIsAllDay = isAllDay;
        
        if (isAllDay)
        {
            primaryDay.StartTime = null;
            primaryDay.EndTime = null;
        }
        else
        {
            UpdatePrimaryStartTime();
            UpdatePrimaryEndTime();
        }
    }
    
    private void UpdatePrimaryStartTime()
    {
        if (!primaryDayIsAllDay && TimeSpan.TryParse(primaryDayStartTime, out var startTime))
        {
            primaryDay.StartTime = primaryDay.Date.Date.Add(startTime);
        }
    }
    
    private void UpdatePrimaryEndTime()
    {
        if (!primaryDayIsAllDay && TimeSpan.TryParse(primaryDayEndTime, out var endTime))
        {
            primaryDay.EndTime = primaryDay.Date.Date.Add(endTime);
        }
    }
    
    private void UpdatePrimaryStartTimeFromInput(string? timeValue)
    {
        if (!string.IsNullOrEmpty(timeValue))
        {
            primaryDayStartTime = timeValue;
            UpdatePrimaryStartTime();
        }
    }
    
    private void UpdatePrimaryEndTimeFromInput(string? timeValue)
    {
        if (!string.IsNullOrEmpty(timeValue))
        {
            primaryDayEndTime = timeValue;
            UpdatePrimaryEndTime();
        }
    }
    
    // Additional days time management helpers
    private bool GetIsAllDay(EventDay day)
    {
        return dayIsAllDay.GetValueOrDefault(day.DayNumber, true);
    }
    
    private string GetStartTimeString(EventDay day)
    {
        return dayStartTimes.GetValueOrDefault(day.DayNumber, "09:00");
    }
    
    private string GetEndTimeString(EventDay day)
    {
        return dayEndTimes.GetValueOrDefault(day.DayNumber, "15:00");
    }
    
    private void OnAllDayChanged(EventDay day, bool isAllDay)
    {
        dayIsAllDay[day.DayNumber] = isAllDay;
        
        if (isAllDay)
        {
            // Set to all day - clear specific times
            day.StartTime = null;
            day.EndTime = null;
        }
        else
        {
            // Set specific times
            UpdateStartTime(day);
            UpdateEndTime(day);
        }
    }
    
    private void UpdateStartTime(EventDay day)
    {
        if (!GetIsAllDay(day) && TimeSpan.TryParse(GetStartTimeString(day), out var startTime))
        {
            day.StartTime = day.Date.Date.Add(startTime);
        }
    }
    
    private void UpdateEndTime(EventDay day)
    {
        if (!GetIsAllDay(day) && TimeSpan.TryParse(GetEndTimeString(day), out var endTime))
        {
            day.EndTime = day.Date.Date.Add(endTime);
        }
    }
    
    private void UpdateStartTimeFromInput(EventDay day, string? timeValue)
    {
        if (!string.IsNullOrEmpty(timeValue))
        {
            dayStartTimes[day.DayNumber] = timeValue;
            UpdateStartTime(day);
        }
    }
    
    private void UpdateEndTimeFromInput(EventDay day, string? timeValue)
    {
        if (!string.IsNullOrEmpty(timeValue))
        {
            dayEndTimes[day.DayNumber] = timeValue;
            UpdateEndTime(day);
        }
    }

    private async Task SaveEvent()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;
        isSaving = true;
        
        try
        {
            if (createEventDto == null) return;

            // Validate required fields
            if (string.IsNullOrWhiteSpace(createEventDto.Title))
            {
                errorMessage = "Event title is required.";
                return;
            }
            if (createEventDto.SchoolYearId == 0)
            {
                errorMessage = "Please select a school year.";
                return;
            }
            if (createEventDto.EventCatId == 0)
            {
                errorMessage = "Please select an event category.";
                return;
            }
            
            // Validate primary day has a date
            if (primaryDay.Date == DateTime.MinValue)
            {
                errorMessage = "Please set a date for the event.";
                return;
            }
            
            // NEW: Validate coordinator assignment based on category requirements
            if (IsCoordinatorRequired() && string.IsNullOrEmpty(createEventDto.EventCoordinatorId))
            {
                errorMessage = "A coordinator is required for events in this category.";
                return;
            }
            
            // Set EventSubTypeId properly - null if not selected
            createEventDto.EventSubTypeId = eventSubCategoryId > 0 ? eventSubCategoryId : null;
            
            // Update event dates based on all days (primary + additional)
            var allDays = new List<EventDay> { primaryDay };
            allDays.AddRange(additionalDays);
            
            createEventDto.Date = allDays.Min(d => d.Date);
            createEventDto.EventStartTime = allDays.Min(d => d.StartTime ?? d.Date.AddHours(9));
            createEventDto.EventEndTime = allDays.Max(d => d.EndTime ?? d.Date.AddHours(15));
            
            HttpResponseMessage response = await Http.PostAsJsonAsync("api/events", createEventDto);
            if (response.IsSuccessStatusCode)
            {
                var createdEvent = await response.Content.ReadFromJsonAsync<Event>();
                
                // Save all event days (primary + additional) using DTOs
                if (createdEvent != null)
                {
                    // Save primary day using DTO
                    var primaryDayDto = new CreateEventDayDTO
                    {
                        EventId = createdEvent.Id,
                        DayNumber = primaryDay.DayNumber,
                        Date = primaryDay.Date,
                        DayTitle = primaryDay.DayTitle,
                        Description = primaryDay.Description,
                        Location = primaryDay.Location,
                        StartTime = primaryDay.StartTime,
                        EndTime = primaryDay.EndTime,
                        IsActive = primaryDay.IsActive,
                        SpecialInstructions = primaryDay.SpecialInstructions,
                        MaxAttendees = primaryDay.MaxAttendees,
                        EstimatedAttendees = primaryDay.EstimatedAttendees,
                        WeatherBackupPlan = primaryDay.WeatherBackupPlan
                    };

                    var primaryResponse = await Http.PostAsJsonAsync($"api/events/{createdEvent.Id}/days", primaryDayDto);
                    if (!primaryResponse.IsSuccessStatusCode)
                    {
                        var dayError = await primaryResponse.Content.ReadAsStringAsync();
                        errorMessage = $"Error saving primary event day: {dayError}";
                        return;
                    }
                    
                    // Save additional days using DTOs
                    foreach (var day in additionalDays)
                    {
                        var additionalDayDto = new CreateEventDayDTO
                        {
                            EventId = createdEvent.Id,
                            DayNumber = day.DayNumber,
                            Date = day.Date,
                            DayTitle = day.DayTitle,
                            Description = day.Description,
                            Location = day.Location,
                            StartTime = day.StartTime,
                            EndTime = day.EndTime,
                            IsActive = day.IsActive,
                            SpecialInstructions = day.SpecialInstructions,
                            MaxAttendees = day.MaxAttendees,
                            EstimatedAttendees = day.EstimatedAttendees,
                            WeatherBackupPlan = day.WeatherBackupPlan
                        };

                        var dayResponse = await Http.PostAsJsonAsync($"api/events/{createdEvent.Id}/days", additionalDayDto);
                        if (!dayResponse.IsSuccessStatusCode)
                        {
                            var dayError = await dayResponse.Content.ReadAsStringAsync();
                            errorMessage = $"Error saving event day: {dayError}";
                            return;
                        }
                    }
                }
                
                successMessage = "Event saved successfully!";
                await Task.Delay(1500); // Show success message briefly
                NavigationManager.NavigateTo("/admin/events");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                errorMessage = $"Error saving event: {error}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void OnCategoryChanged()
    {
        // Reset subcategory when category changes
        eventSubCategoryId = 0;
        StateHasChanged();
    }

    private void CancelEdit()
    {
        NavigationManager.NavigateTo("/admin/events");
    }

    private bool ShouldShowCoordinatorField()
    {
        if (createEventDto?.EventCatId == 0 || eventCategories == null)
            return true; // Default to showing if category not selected

        var category = eventCategories.FirstOrDefault(c => c.Id == createEventDto.EventCatId);
        return category?.CoordinatorRequirement != EventCoordinatorRequirement.NotNeeded;
    }

    private bool IsCoordinatorRequired()
    {
        if (createEventDto?.EventCatId == 0 || eventCategories == null)
            return false; // Default to not required

        var category = eventCategories.FirstOrDefault(c => c.Id == createEventDto.EventCatId);
        return category?.CoordinatorRequirement == EventCoordinatorRequirement.Required;
    }
}
