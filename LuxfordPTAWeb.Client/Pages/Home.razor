@page "/"
@inject HttpClient Http
@inject LuxfordPTAWeb.Client.Code.SchoolYearSupport SchoolYearSupport

<PageTitle>Home</PageTitle>

<!-- Welcome Card -->
<div class="card shadow-sm mb-4">
	<div class="card-body">
		<h1 class="card-title text-center mb-3">Welcome to Luxford Elementary PTA</h1>
		<p class="lead text-center mb-0">
			Welcome to the official website of the Luxford Elementary Parent Teacher Association! We're a dedicated group of parents, teachers, and community members working together to enhance the educational experience for all students at Luxford Elementary School.
		</p>
	</div>
</div>

<!-- About & Announcements Row -->
<div class="row mb-4">
	<div class="col-md-6 mb-3 mb-md-0">
		<div class="card h-100">
			<div class="card-header bg-success text-white fw-bold">About Our PTA</div>
			<div class="card-body">
				<p>
					The Luxford Elementary PTA is committed to fostering a strong partnership between families and our school. Through fundraising, volunteer efforts, and community building, we support our students, teachers, and educational programs.
				</p>
				<ul class="list-unstyled mb-0">
					<li><strong>Our School:</strong> Luxford Elementary School</li>
					<li><strong>Address:</strong> 4808 Haygood Rd, Virginia Beach, VA 23455</li>
					<li><strong>Website:</strong> <a href="https://luxfordes.vbschools.com/" target="_blank">luxfordes.vbschools.com</a></li>
				</ul>
			</div>
		</div>
	</div>
	<!-- PTA Board Card -->
	<div class="col-md-6 mb-3 mb-md-0">
		<div class="card h-100">
			<div class="card-header bg-info text-white fw-bold">
				PTA Board Members
				<span class="fw-normal">@boardYearLabel</span>
			</div>
			<div class="card-body">
				@if (isLoadingBoard)
				{
					<div class="alert alert-info text-center">
						<em>Loading board members...</em>
					</div>
				}
				else if (boardMembers == null || !boardMembers.Any())
				{
					<div class="alert alert-warning text-center">
						<em>No board members found for this year.</em>
					</div>
					if (iselectionEvent)
					{
						<div>
							Click here for the election details.
						</div>
					}
				}
				else
				{
					<ul class="list-group list-group-flush mb-0">
						@foreach (var member in boardMembers)
						{
							<li class="list-group-item @(HasMemberDetails(member) ? "clickable-member" : "")" 
								@onclick="() => ShowMemberDetails(member)" 
								style="@(HasMemberDetails(member) ? "cursor: pointer;" : "")">
								<div class="d-flex justify-content-between align-items-center">
									<div>
										<strong class="@(HasMemberDetails(member) ? "text-info" : "")">@member.Title:</strong> 
										@member.FullName
									</div>
									@if (HasMemberDetails(member))
									{
										<i class="bi bi-info-circle-fill text-info" title="Click for more details"></i>
									}
								</div>
							</li>
						}
					</ul>
				}
			</div>
		</div>
	</div>
</div>

@if (isCurrentYear)
{
	<!-- Announcements & Reminders: Full Width Row -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card shadow-sm">
				<div class="card-header bg-primary text-white fw-bold">Announcements & Reminders</div>
				<div class="card-body">
					<div class="row">
						<div class="col-md-6 mb-3 mb-md-0">
							<h5 class="mb-1">📸 Picture Day</h5>
							<div>
								<strong>Date:</strong> September 18, 2025<br />
								<strong>Picture Day ID:</strong> EVTB9GRC4
							</div>
							<small class="text-muted">Don't forget to order your school pictures! Check your email for instructions.</small>
						</div>
						<div class="col-md-6">
							<h6 class="mb-1">Other Reminders</h6>
							<ul class="mb-0">
								<li>First PTA Meeting: October 7, 2025 5:00 PM Back Playground</li>
								<li>Volunteer Signups Open!</li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Events Row -->
	<div class="row mb-4">
		<div class="col-md-6 mb-3 mb-md-0">
			<div class="card h-100">
				<div class="card-header bg-secondary text-white fw-bold">Previous Events</div>
				<div class="card-body">
					<ul class="list-unstyled mb-0">
						<li><strong>5th Grade Airshow Field Trip</strong> - Sep 19, 2025</li>
						<li><strong>Chuck E. Cheese Night</strong> – Sep 19, 2025</li>
						<li><strong>Picture Day</strong> – Sep 18, 2025</li>
						<li><strong>Back to School Night</strong> – Aug 21, 2025</li>
						<li><strong>PTA Board Election</strong> – Aug 20, 2025</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="card h-100">
				<div class="card-header bg-info text-white fw-bold">Upcoming Events</div>
				<div class="card-body">
					<ul class="list-unstyled mb-0">
						<li><strong>Skate Night</strong> – Sep 30, 2025</li>
						<li><strong>PTA Meeting and Ice cream social</strong> – Oct 7, 2025</li>
						<li><strong>Trunk or Treat Fall Festival</strong> - Oct 24, 2025</li>
						<li><strong>Bingo Night</strong> - Nov 7th, 2025</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
	<div class="d-flex justify-content-center mb-4">
		<NavLink href="events" class="btn btn-lg btn-success px-5 fw-bold">View All Events</NavLink>
	</div>

	<!-- Get Involved Card -->
	<div class="card shadow-sm mb-4">
		<div class="card-header bg-success text-white fw-bold">Get Involved</div>
		<div class="card-body">
			<p>We're always looking for volunteers and supporters! Help us make a difference for our students and school community.</p>
			<NavLink href="get-involved" class="btn btn-outline-success fw-bold">Learn More & Sign Up</NavLink>
		</div>
	</div>
}

<!-- Contact Card -->
<div class="card shadow-sm mb-4">
	<div class="card-header bg-light fw-bold">Contact Us</div>
	<div class="card-body">
		<p>
			<strong>General Questions:</strong> <a href="mailto:luxfordpta1@gmail.com">luxfordpta1@gmail.com</a>
		</p>
	</div>
</div>

<div class="alert alert-success text-center mt-4">
	<em>Thank you for being part of the Luxford Elementary community! Together, we're making a difference in our children's education.</em>
</div>

<!-- Board Member Details Modal -->
@if (selectedMember != null)
{
	<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);" @onclick="CloseModal">
		<div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
			<div class="modal-content">
				<div class="modal-header bg-info text-white">
					<h5 class="modal-title">
						<i class="bi bi-person-badge me-2"></i>@selectedMember.Title
					</h5>
					<button type="button" class="btn-close btn-close-white" @onclick="CloseModal"></button>
				</div>
				<div class="modal-body">
					<h6 class="mb-3">
						<i class="bi bi-person me-2"></i>@selectedMember.FullName
					</h6>
					
					@if (!string.IsNullOrWhiteSpace(selectedMember.PositionDescription))
					{
						<div class="mb-3">
							<strong>Position Description:</strong>
							<p class="mb-0 text-muted">@selectedMember.PositionDescription</p>
						</div>
					}
					
					@if (!string.IsNullOrWhiteSpace(selectedMember.Bio))
					{
						<div class="mb-0">
							<strong>About @selectedMember.FullName.Split(' ')[0]:</strong>
							<p class="mb-0">@selectedMember.Bio</p>
						</div>
					}

					@if (string.IsNullOrWhiteSpace(selectedMember.PositionDescription) && string.IsNullOrWhiteSpace(selectedMember.Bio))
					{
						<p class="text-muted mb-0">
							<em>No additional information available for this board member.</em>
						</p>
					}
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" @onclick="CloseModal">Close</button>
				</div>
			</div>
		</div>
	</div>
}

<style>
	.clickable-member:hover {
		background-color: rgba(0, 123, 255, 0.1) !important;
		transition: background-color 0.2s ease;
	}
	
	.modal.show {
		display: block !important;
	}
</style>

@code {
	private List<BoardMemberDto> boardMembers = new();
	private string boardYearLabel = "";
	private bool isLoadingBoard = true;
	private bool iselectionEvent = false;
	private bool isCurrentYear = false;
	private BoardMemberDto? selectedMember = null;

	protected override async Task OnInitializedAsync()
	{
		isLoadingBoard = true;
		try
		{
			// Get the current school year
			var schoolYear = await SchoolYearSupport.GetSelectedSchoolYearInfoAsync();
			if (schoolYear != null)
			{
				isCurrentYear = schoolYear.Status == Shared.Enums.SchoolYearStatus.CurrentYear;
				boardYearLabel = $"{schoolYear.Name}";
				// Get board positions for this year, only filled spots
				var positions = await Http.GetFromJsonAsync<List<BoardPositionDto>>($"api/boardpositions/all-by-schoolyear/{schoolYear.Id}");
				boardMembers = positions?
					.Where(bp => bp.AssignedUser != null)
					.Select(bp => new BoardMemberDto
					{
						Title = bp.BoardPositionTitle?.Title ?? "Unknown",
						FullName = bp.AssignedUser.FullName,
						Bio = bp.AssignedUser.Bio ?? "",
						PositionDescription = bp.BoardPositionTitle?.Description ?? ""
					})
					.ToList() ?? new List<BoardMemberDto>();
			}
		}
		catch
		{
			boardMembers = new();
		}
		isLoadingBoard = false;
	}

	private bool HasMemberDetails(BoardMemberDto member)
	{
		// Show info button if there is position description OR bio
		return !string.IsNullOrWhiteSpace(member.PositionDescription) || !string.IsNullOrWhiteSpace(member.Bio);
	}

	private void ShowMemberDetails(BoardMemberDto member)
	{
		if (HasMemberDetails(member))
		{
			selectedMember = member;
			StateHasChanged();
		}
	}

	private void CloseModal()
	{
		selectedMember = null;
		StateHasChanged();
	}

	public class BoardMemberDto
	{
		public string Title { get; set; } = "";
		public string FullName { get; set; } = "";
		public string Bio { get; set; } = "";
		public string PositionDescription { get; set; } = "";
	}

	public class BoardPositionDto
	{
		public int Id { get; set; }
		public BoardPositionTitleDto? BoardPositionTitle { get; set; }
		public int BoardPositionTitleId { get; set; }
		public ApplicationUserDto? AssignedUser { get; set; }
	}

	public class BoardPositionTitleDto
	{
		public int Id { get; set; }
		public string Title { get; set; } = "";
		public string Description { get; set; } = "";
	}

	public class ApplicationUserDto
	{
		public string Id { get; set; } = "";
		public string FullName { get; set; } = "";
		public string Bio { get; set; } = "";
	}
}
