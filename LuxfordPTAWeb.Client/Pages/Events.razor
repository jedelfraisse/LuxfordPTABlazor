@page "/events"
@inject HttpClient Http

<PageTitle>Events</PageTitle>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h1 class="card-title text-center mb-3">Events!</h1>
        <p class="lead text-center mb-0">
            Welcome to the events page for Luxford Elementary School. Here you'll find both PTA and school events, organized by category to help you plan your year and stay involved in our community.
        </p>
    </div>
</div>

<div class="alert alert-primary text-center mb-4">
    <h5 class="mb-2">📅 <strong><a href="images/eventcal-2025-2026.jpg" target="_blank">Download Printable Event Calendar →</a></strong></h5>
    <em>Print and post this handy calendar with all events for the 2025-2026 school year!</em>
</div>

<h2 class="h4 mt-4">Event Categories</h2>
<p>Browse our events by category:</p>

@if (eventTypes == null)
{
    <div class="alert alert-info">
        <em>Loading event categories...</em>
    </div>
}
else
{
    <div class="row mb-4">
        @foreach (var eventType in eventTypes.Where(et => et.IsActive && et.DisplayMode == 0).OrderBy(et => et.DisplayOrder))
        {
            var colClass = eventType.Size == 1 ? "col-12 mb-3" : "col-md-6 mb-3";
            <div class="@colClass">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title @eventType.ColorClass">
                            @if (!string.IsNullOrEmpty(eventType.Icon))
                            {
                                <i class="@eventType.Icon"></i>
                            }
                            @if (eventType.ShowViewEventsButton)
                            {
                                <a href="events/category/@eventType.Slug" class="text-decoration-none">@eventType.Name</a>
                            }
                            else
                            {
                                @eventType.Name
                            }
                        </h5>
                        <p class="card-text">@eventType.Description</p>
                        <div class="mt-auto">
                            <span class="badge @(eventType.IsMandatory ? "bg-danger" : "bg-info") me-2">
                                @GetEventCount(eventType.Id) events
                            </span>
                            @if (eventType.ShowViewEventsButton)
                            {
                                <a href="events/category/@eventType.Slug" class="btn btn-sm btn-outline-primary">
                                    View Events <i class="bi bi-arrow-right"></i>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
}

@* Display inline event sections for event types configured to show directly *@
@if (eventTypes != null && allEvents != null)
{
    @foreach (var eventType in eventTypes.Where(et => et.IsActive && (et.DisplayMode == 2 || et.DisplayMode == 3)).OrderBy(et => et.DisplayOrder))
    {
        var eventsToShow = GetEventsForType(eventType.Id, eventType.DisplayMode, eventType.MaxEventsToShow);
        
        if (eventsToShow.Any())
        {
            <div class="card mb-4">
                <div class="card-header @GetHeaderColorClass(eventType) text-white fw-bold">
                    @if (!string.IsNullOrEmpty(eventType.Icon))
                    {
                        <i class="@eventType.Icon me-2"></i>
                    }
                    @eventType.Name (@GetCurrentSchoolYear())
                </div>
                <div class="card-body">
                    @if (eventType.Id == 1) // School Closed & Special Days
                    {
                        @RenderSchoolClosedEvents(eventsToShow)
                    }
                    else
                    {
                        @RenderRegularEvents(eventsToShow)
                    }
                    
                    @if (eventType.ShowViewEventsButton && eventsToShow.Count() < GetEventCount(eventType.Id))
                    {
                        <div class="text-end mt-3">
                            <a href="events/category/@eventType.Slug" class="btn btn-sm btn-outline-primary">
                                View All @eventType.Name <i class="bi bi-arrow-right"></i>
                            </a>
                        </div>
                    }
                </div>
            </div>
        }
    }
}

<h2 class="h4 mt-4">📅 Upcoming Events</h2>
@if (upcomingEvents == null)
{
    <div class="alert alert-info">
        <em>Loading events... @testtext</em>
    </div>
}
else if (!upcomingEvents.Any())
{
    <div class="alert alert-warning">
        <em>No upcoming events in the next 30 days.</em>
    </div>
}
else
{
    <ul class="list-group list-group-flush mb-4">
        @foreach (var evt in upcomingEvents)
        {
            <li class="list-group-item">
                <strong>@evt.Title</strong><br />
                <small class="text-muted">@evt.Date.ToString("MMMM d, yyyy")</small><br />
                @evt.Description
                @if (!string.IsNullOrWhiteSpace(evt.Location))
                {
                    <div><em>@evt.Location</em></div>
                }
            </li>
        }
    </ul>
}

<h2 class="h4 mt-4">🕰️ Past Events</h2>
<div class="accordion mb-4" id="pastEventsAccordion">
    <div class="accordion-item">
        <h3 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#year2025" aria-expanded="true">
                2025-2026 School Year
            </button>
        </h3>
        <div id="year2025" class="accordion-collapse collapse show" data-bs-parent="#pastEventsAccordion">
            <div class="accordion-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <strong>PTA Board Election 2025-2026</strong> – August 20, 2025, School Cafeteria:
                        Elected the new board for the year. <a href="pta-board-election">View Election Details →</a>
                    </li>
                    <li class="mb-2">
                        <strong>PTA Back to School Event</strong> – August 21, 2025, School Campus:
                        Welcomed families and introduced the new board. <a href="back-to-school-night">View Event Details →</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h3 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#year2024">
                2024–2025 School Year
            </button>
        </h3>
        <div id="year2024" class="accordion-collapse collapse" data-bs-parent="#pastEventsAccordion">
            <div class="accordion-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><strong>Spring Carnival</strong> – April 2025: Over 200 attendees, raised $2,000!</li>
                    <li class="mb-2"><strong>Book Fair</strong> – March 2025: Thank you to all our volunteers!</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h3 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#year2023">
                2023–2024 School Year
            </button>
        </h3>
        <div id="year2023" class="accordion-collapse collapse" data-bs-parent="#pastEventsAccordion">
            <div class="accordion-body">
                <ul class="list-unstyled">
                    <li class="mb-2"><strong>Fall Festival</strong> – October 2023: Games, food, and fun for all ages.</li>
                    <li class="mb-2"><strong>Bingo Night</strong> – January 2024: Family fun and fundraising success.</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white fw-bold">🙋‍♀️ Get Involved</div>
    <div class="card-body">
        <p>We're always looking for volunteers to help make our events successful! Contact our Event Coordinator: Ashley Threadgill</p>
    </div>
</div>

<div class="alert alert-success text-center mt-4">
    <em>Mark your calendars and join us for these wonderful community events!</em><br />
    <strong>Email List</strong> - Contact us at: TBD
</div>

@code {
    private List<EventDto>? upcomingEvents;
    private List<EventTypeDto>? eventTypes;
    private List<EventDto>? allEvents;
    string testtext = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadEventTypes();
        await LoadUpcomingEvents();
        await LoadAllEvents();
    }

    private async Task LoadEventTypes()
    {
        try
        {
            eventTypes = await Http.GetFromJsonAsync<List<EventTypeDto>>("api/eventtypes");
        }
        catch (Exception)
        {
            eventTypes = new List<EventTypeDto>();
        }
    }

    private async Task LoadUpcomingEvents()
    {
        try
        {
            testtext = "Calling API...";
            var response = await Http.GetAsync("api/events/upcoming");
            
            if (response.IsSuccessStatusCode)
            {
                upcomingEvents = await response.Content.ReadFromJsonAsync<List<EventDto>>();
                testtext = $"Successfully loaded {upcomingEvents?.Count ?? 0} events!";
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                testtext = $"API Error: {response.StatusCode} - {error}";
            }
        }
        catch (Exception ex)
        {
            testtext = "Exception occurred: " + ex.Message;
        }
    }

    private async Task LoadAllEvents()
    {
        try
        {
            allEvents = await Http.GetFromJsonAsync<List<EventDto>>("api/events");
        }
        catch (Exception)
        {
            allEvents = new List<EventDto>();
        }
    }

    private int GetEventCount(int eventTypeId)
    {
        return allEvents?.Count(e => e.EventType?.Id == eventTypeId) ?? 0;
    }

    private RenderFragment RenderSchoolClosedEvents(IEnumerable<EventDto> events) => __builder =>
    {
        var holidays = events.Where(e => e.Title.Contains("Holiday") || e.Title.Contains("Day") || e.Title.Contains("Break")).OrderBy(e => e.Date);
        var staffDays = events.Where(e => e.Title.Contains("Staff") || e.Title.Contains("Training")).OrderBy(e => e.Date);
        var adjustedDays = events.Where(e => e.Title.Contains("Adjusted") || e.Title.Contains("Dismissal")).OrderBy(e => e.Date);

        __builder.OpenElement(0, "div");
        __builder.AddAttribute(1, "class", "row");
        
        if (holidays.Any())
        {
            __builder.OpenElement(2, "div");
            __builder.AddAttribute(3, "class", "col-md-6");
            __builder.OpenElement(4, "h5");
            __builder.AddContent(5, "Holidays (School Closed)");
            __builder.CloseElement();
            __builder.OpenElement(6, "ul");
            __builder.AddAttribute(7, "class", "list-unstyled");
            
            foreach (var holiday in holidays)
            {
                __builder.OpenElement(8, "li");
                __builder.OpenElement(9, "strong");
                __builder.AddContent(10, holiday.Title + ":");
                __builder.CloseElement();
                __builder.AddContent(11, " " + holiday.Date.ToString("MMMM d, yyyy"));
                __builder.CloseElement();
            }
            
            __builder.CloseElement(); // ul
            __builder.CloseElement(); // div col-md-6
        }
        
        if (adjustedDays.Any() || staffDays.Any())
        {
            __builder.OpenElement(12, "div");
            __builder.AddAttribute(13, "class", "col-md-6");
            
            if (adjustedDays.Any())
            {
                __builder.OpenElement(14, "h5");
                __builder.AddContent(15, "Adjusted Dismissal Days");
                __builder.CloseElement();
                __builder.OpenElement(16, "ul");
                __builder.AddAttribute(17, "class", "list-unstyled");
                
                foreach (var day in adjustedDays)
                {
                    __builder.OpenElement(18, "li");
                    __builder.OpenElement(19, "strong");
                    __builder.AddContent(20, day.Title + ":");
                    __builder.CloseElement();
                    __builder.AddContent(21, " " + day.Date.ToString("MMMM d, yyyy"));
                    __builder.CloseElement();
                }
                
                __builder.CloseElement(); // ul
            }
            
            if (staffDays.Any())
            {
                __builder.OpenElement(22, "h5");
                __builder.AddAttribute(23, "class", "mt-3");
                __builder.AddContent(24, "Staff Days (School Closed for Students)");
                __builder.CloseElement();
                __builder.OpenElement(25, "ul");
                __builder.AddAttribute(26, "class", "list-unstyled");
                
                foreach (var day in staffDays)
                {
                    __builder.OpenElement(27, "li");
                    __builder.AddContent(28, day.Date.ToString("MMMM d, yyyy"));
                    __builder.CloseElement();
                }
                
                __builder.CloseElement(); // ul
            }
            
            __builder.CloseElement(); // div col-md-6
        }
        
        __builder.CloseElement(); // div row
    };

    private RenderFragment RenderRegularEvents(IEnumerable<EventDto> events) => __builder =>
    {
        __builder.OpenElement(0, "ul");
        __builder.AddAttribute(1, "class", "list-group list-group-flush");
        
        foreach (var evt in events.OrderBy(e => e.Date))
        {
            __builder.OpenElement(2, "li");
            __builder.AddAttribute(3, "class", "list-group-item");
            __builder.OpenElement(4, "strong");
            __builder.AddContent(5, evt.Title);
            __builder.CloseElement();
            __builder.OpenElement(6, "br");
            __builder.CloseElement();
            __builder.OpenElement(7, "small");
            __builder.AddAttribute(8, "class", "text-muted");
            __builder.AddContent(9, evt.Date.ToString("MMMM d, yyyy"));
            __builder.CloseElement();
            __builder.OpenElement(10, "br");
            __builder.CloseElement();
            
            if (!string.IsNullOrWhiteSpace(evt.Description))
            {
                __builder.AddContent(11, evt.Description);
            }
            
            if (!string.IsNullOrWhiteSpace(evt.Location))
            {
                __builder.OpenElement(12, "div");
                __builder.OpenElement(13, "em");
                __builder.AddContent(14, evt.Location);
                __builder.CloseElement();
                __builder.CloseElement();
            }
            
            __builder.CloseElement(); // li
        }
        
        __builder.CloseElement(); // ul
    };

    private IEnumerable<EventDto> GetEventsForType(int eventTypeId, int displayMode, int maxEvents)
    {
        if (allEvents == null) return Enumerable.Empty<EventDto>();
        
        var events = allEvents.Where(e => e.EventType?.Id == eventTypeId);
        
        // For school closed events, show upcoming and some recent/relevant ones
        if (eventTypeId == 1)
        {
            var currentDate = DateTime.Now;
            var currentSchoolYearStart = new DateTime(currentDate.Month >= 7 ? currentDate.Year : currentDate.Year - 1, 7, 1);
            var currentSchoolYearEnd = currentSchoolYearStart.AddYears(1).AddDays(-1);
            
            events = events.Where(e => e.Date >= currentSchoolYearStart && e.Date <= currentSchoolYearEnd);
        }
        
        return displayMode == 3 && maxEvents > 0 ? events.Take(maxEvents) : events;
    }

    private string GetHeaderColorClass(EventTypeDto eventType)
    {
        return eventType.ColorClass switch
        {
            "text-danger" => "bg-danger",
            "text-success" => "bg-success", 
            "text-primary" => "bg-primary",
            "text-info" => "bg-info",
            "text-warning" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    private string GetCurrentSchoolYear()
    {
        var currentDate = DateTime.Now;
        var startYear = currentDate.Month >= 7 ? currentDate.Year : currentDate.Year - 1;
        return $"{startYear}–{startYear + 1}";
    }

    public class EventDto
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public string Description { get; set; } = string.Empty;
        public string Location { get; set; } = string.Empty;
        public string ImageUrl { get; set; } = string.Empty;
        public string Link { get; set; } = string.Empty;
        public EventTypeDto? EventType { get; set; }
        public SchoolYearDto? SchoolYear { get; set; }
    }

    public class EventTypeDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Slug { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public bool IsMandatory { get; set; }
        public int DisplayOrder { get; set; }
        public bool IsActive { get; set; }
        public int Size { get; set; }
        public string Icon { get; set; } = string.Empty;
        public string ColorClass { get; set; } = string.Empty;
        
        // New properties for display configuration
        public int DisplayMode { get; set; } = 0; // EventDisplayMode as int
        public int MaxEventsToShow { get; set; } = 0;
        public bool ShowViewEventsButton { get; set; } = true;
        public bool ShowInlineOnMainPage { get; set; } = false;
    }

    public class SchoolYearDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
    }
}
